#!/bin/bash

VAL="$1"
VALUE_FILE="/var/lib/limit-charge/value"
CONFIG_FILE="/etc/limit-charge.conf"
DETECT="/usr/lib/limit-charge/detect-sys-file"

# resolve SYS_FILE
SYS_FILE=""
if [[ -f "$CONFIG_FILE" ]]; then
  . "$CONFIG_FILE"
fi
if [[ -z "$SYS_FILE" ]]; then
  if SYS_FILE=$("$DETECT"); then
    :
  else
    echo "Could not determine battery threshold sysfs file."
    exit 1
  fi
fi

if [[ -z "$VAL" ]]; then
  echo "Usage: limit-charge <0-100|get>"
  exit 1
fi

if [[ "$VAL" == "get" ]]; then
  if [[ -f "$VALUE_FILE" ]]; then
    cat "$VALUE_FILE"
  else
    echo "No stored limit."
  fi
  exit 0
fi

if ! [[ "$VAL" =~ ^[0-9]+$ ]]; then
  echo "Error: value must be a number"
  exit 1
fi

if (( VAL < 1 || VAL > 100 )); then
  echo "Error: value must be between 1 and 100"
  exit 1
fi

# write to sysfs (needs sudo/root)
echo "$VAL" | sudo tee "$SYS_FILE" > /dev/null

# store for service
echo "$VAL" | sudo tee "$VALUE_FILE" > /dev/null

echo "Charge limit set to $VAL% (to $SYS_FILE)"
